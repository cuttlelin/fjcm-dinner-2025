<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚äº’å‹•ç‰†</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
</head>
<body>

<div class="dashboard-container">
    <header style="margin-top: 20px;">
        <h1>è¼”ä»å¤§å­¸ç®¡ç†å­¸é™¢ - æ ¡å‹å¿ƒè²ç‰† ğŸ“</h1>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('cloud')">â˜ï¸ å°è±¡é—œéµå­— (æ–‡å­—é›²)</button>
        <button class="tab-btn" onclick="switchTab('list')">ğŸ“ æ ¡å‹ç•™è¨€æ¿ (åˆ—è¡¨)</button>
    </div>

    <div id="word-cloud-view" class="active">
        <canvas id="cloud-canvas"></canvas>
    </div>

    <div id="list-view">
        <div class="response-grid" id="response-list">
            </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

  // TODO: è«‹åœ¨æ­¤è™•è²¼ä¸ŠåŒæ¨£çš„ Firebase Config
  const firebaseConfig = {
   apiKey: "AIzaSyDWWXuU16UwB8iXo5tEVuzYYVP9ppslisk",
  authDomain: "fjcu-dinner.firebaseapp.com",
  projectId: "fjcu-dinner",
  storageBucket: "fjcu-dinner.firebasestorage.app",
  messagingSenderId: "461813917984",
  appId: "1:461813917984:web:717f2404d20dd9a0d68f45",
  measurementId: "G-9TQS9R3CDC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const canvas = document.getElementById('cloud-canvas');
  // è¨­å®š Canvas å¤§å°
  canvas.width = document.getElementById('word-cloud-view').offsetWidth;
  canvas.height = document.getElementById('word-cloud-view').offsetHeight;

  // ç›£è½è³‡æ–™åº«è®ŠåŒ–
  const q = query(collection(db, "responses"), orderBy("timestamp", "desc"));
  
  onSnapshot(q, (snapshot) => {
      const wordsMap = {};
      const responsesHTML = [];

      snapshot.forEach((doc) => {
          const data = doc.data();
          
          // è™•ç†æ–‡å­—é›² (è¨ˆç®—æ¬¡æ•¸)
          // ç°¡å–®è™•ç†ï¼šç›´æ¥ç”¨è¼¸å…¥çš„çŸ­å¥ç•¶ä½œé—œéµå­—
          const key = data.impression.trim();
          if (key) {
              wordsMap[key] = (wordsMap[key] || 0) + 1;
          }

          // è™•ç†åˆ—è¡¨
          responsesHTML.push(`
              <div class="response-card">
                  <span class="keyword-tag">#${data.impression}</span>
                  <p>${data.message}</p>
              </div>
          `);
      });

      // æ›´æ–°åˆ—è¡¨
      document.getElementById('response-list').innerHTML = responsesHTML.join('');

      // æ›´æ–°æ–‡å­—é›²æ•¸æ“šæ ¼å¼
      const wordList = Object.keys(wordsMap).map(key => [key, wordsMap[key] * 15 + 10]); // æ¬Šé‡æ”¾å¤§å­—é«”
      
      // ç¹ªè£½æ–‡å­—é›²
      if(document.getElementById('word-cloud-view').classList.contains('active')){
          WordCloud(canvas, { 
              list: wordList,
              gridSize: 8,
              weightFactor: function (size) { return size * 1.5; }, // å­—é«”å¤§å°èª¿æ•´
              fontFamily: 'Noto Sans TC',
              color: 'random-dark',
              backgroundColor: '#ffffff',
              rotateRatio: 0.5
          });
      }
  });

  // ç°¡å–®çš„ Tab åˆ‡æ›åŠŸèƒ½
  window.switchTab = (tab) => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#word-cloud-view, #list-view').forEach(v => v.classList.remove('active'));

      if(tab === 'cloud') {
          document.querySelector('button[onclick="switchTab(\'cloud\')"]').classList.add('active');
          document.getElementById('word-cloud-view').classList.add('active');
          // é‡æ–°è§¸ç™¼æ–‡å­—é›²æ¸²æŸ“ä»¥é©æ‡‰å¤§å°
          location.reload(); // ç°¡å–®æš´åŠ›åˆ·æ–°ç¢ºä¿ Canvas æ­£å¸¸ï¼Œæˆ–å¯é‡æ–°å‘¼å« WordCloud å‡½å¼
      } else {
          document.querySelector('button[onclick="switchTab(\'list\')"]').classList.add('active');
          document.getElementById('list-view').classList.add('active');
      }
  }
</script>

</body>
</html>