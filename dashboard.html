<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時互動牆 - 輔大管院</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
</head>
<body>
    <header>
        <h1>輔大管院 2024 校友晚宴 - 即時互動牆</h1>
    </header>

    <div class="container" style="max-width: 1000px;">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('cloud')">關鍵字雲</button>
            <button class="tab-btn" onclick="switchTab('list')">留言列表 (<span id="count">0</span>)</button>
        </div>

        <div id="view-cloud" class="card">
            <div id="word-cloud-canvas"></div>
            <p style="text-align:center; color:#999; font-size:0.8rem;">* 即時更新中 *</p>
        </div>

        <div id="view-list" class="hidden">
            <ul class="message-list" id="msg-list">
                </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // ⚠️【請將這裡換成與 index.html 完全一樣的設定】⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyDWWXuU16UwB8iXo5tEVuzYYVP9ppslisk",
			authDomain: "fjcu-dinner.firebaseapp.com",
			projectId: "fjcu-dinner",
			storageBucket: "fjcu-dinner.firebasestorage.app",
			messagingSenderId: "461813917984",
			appId: "1:461813917984:web:717f2404d20dd9a0d68f45",
			measurementId: "G-9TQS9R3CDC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let allData = [];

        // 監聽資料庫變化 (Realtime)
        const messagesRef = ref(db, 'messages');
        onValue(messagesRef, (snapshot) => {
            const data = snapshot.val();
            const listEl = document.getElementById('msg-list');
            listEl.innerHTML = ""; // 清空重繪
            allData = [];

            if (data) {
                // 轉成陣列並反轉 (最新的在上面)
                const entries = Object.values(data).reverse();
                document.getElementById('count').innerText = entries.length;

                entries.forEach(item => {
                    allData.push(item);
                    // 建立列表項目
                    const li = document.createElement('li');
                    li.className = 'message-item';
                    li.innerHTML = `<span class="tag">#${item.keyword}</span> <span class="msg-content">${item.content}</span>`;
                    listEl.appendChild(li);
                });

                // 更新文字雲
                updateWordCloud();
            }
        });

        // 文字雲邏輯
        function updateWordCloud() {
            const freq = {};
            allData.forEach(d => {
                let k = d.keyword;
                freq[k] = (freq[k] || 0) + 1;
            });

            const cloudList = [];
            for (const [key, val] of Object.entries(freq)) {
                // 權重放大，讓字比較明顯
                cloudList.push([key, val * 15 + 15]); 
            }

            const canvas = document.getElementById('word-cloud-canvas');
            // 每次重繪前清除
            canvas.innerHTML = ''; 
            
            WordCloud(canvas, {
                list: cloudList,
                gridSize: 10,
                weightFactor: 2,
                fontFamily: '"Microsoft JhengHei", sans-serif',
                color: 'random-dark',
                rotateRatio: 0,
                backgroundColor: 'transparent'
            });
        }

        // 供全域呼叫的切換功能
        window.switchTab = function(tab) {
            if(tab === 'cloud') {
                document.getElementById('view-cloud').classList.remove('hidden');
                document.getElementById('view-list').classList.add('hidden');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.remove('active');
                updateWordCloud(); // 切回來時重繪以免跑版
            } else {
                document.getElementById('view-cloud').classList.add('hidden');
                document.getElementById('view-list').classList.remove('hidden');
                document.querySelectorAll('.tab-btn')[0].classList.remove('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }
    </script>
</body>
</html>